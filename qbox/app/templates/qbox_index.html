{% extends "appbuilder/base.html" %}
{% block content %}
<div class="jumbotron index-box">
  <div class="container">
    <div class="col-sm-6">
      <img src="{{url_for('static',filename='img/Nada_logo.png')}}" alt="" width="80%">
    </div>
    <div class="col-sm-6">
      <h1 class="index-title">{{_("NADA")}}</h1>
    <h3 class="index-subtitle">NATIVE DOCUMENT ARCHIVE</h3> 
    </div>
     
{% if not current_user.is_anonymous %}
<form>
  <div class="col-sm-6">
    <div class="input-group" style="margin-bottom: 10px;">
      <span class="input-group-addon" id="basic-addon1">Project</span>
      <input class="form-control" type="search" 
          name="project" placeholder="Filter By Project Number" 
          hx-post="/dashboard/index" 
          hx-trigger="input changed delay:500ms, search" 
          hx-target="#update-tabledata" 
          hx-indicator=".htmx-indicator"> 
    </div>
    
  
  </div>
  <div class="col-sm-6">
    <div class="input-group">
      <span class="input-group-addon" id="basic-addon1">Document</span>
      <input class="form-control" type="search" 
          name="name" placeholder="Filter By Document Content" 
          hx-post="/dashboard/index" 
          hx-trigger="input changed delay:500ms, search" 
          hx-target="#update-tabledata" 
          hx-indicator=".htmx-indicator"> 
    </div>
  </div>
</form>

{% else %}
<div class="index-login">
    <a href="{{appbuilder.get_url_for_login}}">
    <i class="fa fa-fw fa-sign-in"></i>Please {{_("Login")}}</a>
</div>
{% endif %}
      
  </div>
</div>
<div class="jumbotron index-table">
  <div id="index-tabledata"></div>
  <div>
    <button style="float: right; " class="btn btn-primary" onclick='table.download("csv", "data.csv",";");'><i class="fa-regular fa-file-excel"><span style="margin: 10px;">Download</span>  </i></button>
  </div>

</div>

<div class="jumbotron">
  <div class="row">
    <div style="margin: 40px; text-align:center">
      <h2>Box by Location</h2>
    </div>
    <div class="col-md-6">
      <div class="chart-container" style="position: relative; ">
        <canvas id="siteChart" width="100" height="100"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Site</th>
              <th>Box</th>
            </tr>
          </thead>
          <tbody>
            {% for line in box_site_list %}
            <tr>
            <td>{{line[0]}}</td>
            <td>{{line[1]}}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div>
          <h3 style="text-align: center;">Total: {{'{0:0,.0f}'.format(all_box)}}</h3>
        </div>
      </div>
    </div> 
  </div>
  <hr>
  <div class="row">
    <div style="margin: 40px; text-align:center">
      <h2>Documents by Group (Top 10)</h2>
    </div>
    
    <div class="col-md-6">
      <div class="chart-container" style="position: relative;">
        <canvas id="groupChart" width="100" height="100%"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Site</th>
              <th>Documents</th>
            </tr>
          </thead>
          <tbody>
            {% for line in doc_group_list %}
            <tr>
              <td>{{line[0]}}</td>
              <td>{{line[1]}}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div>
          <h3 style="text-align: center;">Total: {{'{0:0,.0f}'.format(all_doc)}}</h3>
        </div>
      </div>
    </div>
     
  </div>
  <hr>
  <div class="row">
    <div style="margin: 40px; text-align:center">
      <h2>Documents by Due Date (Top 10)</h2>
    </div>
    <div class="chart-container" style="position: relative;">
      <canvas id="duedateChart" width="100" height="50%"></canvas>
    </div>
  </div>
  
</div>

  
<div id="update-tabledata"></div>
<script>
    var tabledata = {{ ie_tabledata |tojson |safe}}
    var printIcon = function(cell, formatterParams, onRendered){ //plain text value
      return "<i class='fa fa-print'></i>";
    };
    var table = new Tabulator("#index-tabledata", {
        maxHeight:"100%",
        rowHeight:40,
        data:tabledata, //assign data to table
        columns:[
            {title:"Name", field:"Name", sorter:"string", width:650},
            {title:"Type", field:"Type", sorter:"number", width:100},
            {title:"Project", field:"Project", sorter:"string", width:100, cellClick:function(e, cell){console.log("cell click")},},
            {title:"Group", field:"Group", width:100},
            {title:"Due Date", field:"due_date", sorter:"date", hozAlign:"center", width:100,formatter:"datetime", formatterParams:{
              inputFormat:"yyyy-MM-dd",
              outputFormat:"dd/MM/yyyy",
              invalidPlaceholder:"(invalid date)",
              timezone:"America/Los_Angeles",
            }},
            {formatter:printIcon, width:40, hozAlign:"center", cellClick:function(e, cell){alert("Printing row data for: " + cell.getRow().getData().name)}},
        ], //create columns from data field names
        columnDefaults:{
          tooltip:function(e, cell, onRendered){
              //e - mouseover event
              //cell - cell component
              //onRendered - onRendered callback registration function
              
              var el = document.createElement("h2");
              el.style.backgroundColor = "white";
              el.innerText = cell.getColumn().getField() + " - " + cell.getValue(); //return cells "field - value";
              
              return el; 
          },
        }
      
    });
    table.on("rowClick", function(e, row){
      //e - the click event object
      //row - row component
      let url = "/volumeview/show/"+row._row.data.id
      window.open(url, '_blank');
      console.log('the row', row)
      tt= row
    });
</script>
<script>
        

  const ctx_group = document.getElementById('groupChart');
  
  var group_data = {{ doc_group_chart_data |tojson | safe }};

  var mb = new Chart(ctx_group, {
    type: 'doughnut',
    data: group_data,
    options: {
      onClick: (event, elements, chart) => {
        const i = elements[0].index;
        
        if (elements[0]) {            
           const i = elements[0].index;
           const di = elements[0].datasetIndex;
           //alert(chart.data.labels[i] + ': ' + chart.data.datasets[di].label);
           //document.getElementById('tag-id').innerHTML = '<div hx-get="/dashboard/type/'+chart.data.labels[i] +'" hx-trigger="load">'+ i +' data</div>';
           //htmx.process(document.getElementById('tag-id'));
           var label = chart.data.labels[i];
           window.open(`/dashboard/chart/group/${label}`);
        }
      },
      plugins: {
          legend: {
              display: true,
              position: 'bottom',
              
          }
      }
    }
  });

  const ctx_site = document.getElementById('siteChart');
  
  var data = {{ box_site_chart_data |tojson | safe }};

  var mg = new Chart(ctx_site, {
    type: 'doughnut',
    data: data,
    options: {
      onClick: (event, elements, chart) => {
        const i = elements[0].index;
        
        if (elements[0]) {            
           const i = elements[0].index;
           const di = elements[0].datasetIndex;
           //alert(chart.data.labels[i] + ': ' + chart.data.datasets[di].label);
           //document.getElementById('tag-id').innerHTML = '<div hx-get="/dashboard/type/'+chart.data.labels[i] +'" hx-trigger="load">'+ i +' data</div>';
           //htmx.process(document.getElementById('tag-id'));
           var label = chart.data.labels[i];
           window.open(`/dashboard/chart/site/${label}`);
        }
      },
      plugins: {
          legend: {
              display: true,
              position: 'bottom',
              
          }
      }
    }
  });

   
  const ctx2 = document.getElementById('duedateChart');
  var data = {{ doc_endlife_chart_data | tojson | safe }};
  

  var md = new Chart(ctx2, {
    type: 'bar',
    data: data,
    options: {
      onClick: (event, elements, chart) => {
        const i = elements[0].index;
        
        if (elements[0]) {            
           const i = elements[0].index;
           const di = elements[0].datasetIndex;
           //alert(chart.data.labels[i] + ': ' + chart.data.datasets[di].label);
           //document.getElementById('tag-id').innerHTML = '<div hx-get="/dashboard/type/'+chart.data.labels[i] +'" hx-trigger="load">'+ i +' data</div>';
           //htmx.process(document.getElementById('tag-id'));
           var label = chart.data.labels[i];
           window.open(`/volumeview/list/?_flt_1_endlife_date=${label}-01-01&_flt_2_endlife_date=${label}-12-31#`,'_blank');
           ///window.open(`/dashboard/chart/year/${label}`,'_blank');

        }
      },
      plugins: {

        legend: {
            display: true
        },
        
        subtitle: {
            position: 'bottom',
            display: true,
            text: 'Custom Chart Subtitle'
        },
        title: {
          position: 'bottom',
          display: true,
          text: 'Custom Chart Title'
        }
      },
      scales: {
        x: {
          stacked: false

        },
        y: {
          stacked: false,
          beginAtZero: true
        }
      }
    }
  });

</script>

{% endblock %}